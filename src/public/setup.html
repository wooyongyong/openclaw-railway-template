<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenClaw Setup</title>
  <link rel="stylesheet" href="/setup/styles.css" />
  <script>
  (function() {
    const saved = localStorage.getItem('theme');
    if (saved) {
      document.documentElement.setAttribute('data-theme', saved);
    }
  })();
  </script>
  <script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('setupApp', () => ({
      theme: localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'),
      status: 'Loading...',
      configured: false,
      openclawVersion: '',
      authGroups: [],
      selectedGroup: '',
      authChoices: [],
      selectedAuth: '',
      authSecret: '',
      flow: 'quickstart',
      telegramToken: '',
      discordToken: '',
      slackBotToken: '',
      slackAppToken: '',
      model: '',
      log: '',
      loading: false,
      pairingChannel: '',
      pairingCode: '',
      showPairingModal: false,

      get currentGroup() {
        return this.authGroups.find(g => g.value === this.selectedGroup);
      },

      async init() {
        await this.refreshStatus();
      },

      toggleTheme() {
        this.theme = this.theme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', this.theme);
        localStorage.setItem('theme', this.theme);
      },

      async httpJson(url, opts = {}) {
        opts.credentials = 'same-origin';
        const res = await fetch(url, opts);
        if (!res.ok) {
          const t = await res.text();
          throw new Error('HTTP ' + res.status + ': ' + (t || res.statusText));
        }
        return res.json();
      },

      async refreshStatus() {
        this.status = 'Loading...';
        try {
          const j = await this.httpJson('/setup/api/status');
          const ver = j.openclawVersion ? (' | ' + j.openclawVersion) : '';
          this.configured = j.configured;
          this.openclawVersion = j.openclawVersion || '';
          this.status = (j.configured ? 'Configured - open /openclaw' : 'Not configured - run setup below') + ver;
          this.authGroups = j.authGroups || [];
          if (this.authGroups.length > 0) {
            this.selectedGroup = this.authGroups[0].value;
            this.updateAuthChoices();
          }
          if (j.channelsAddHelp && j.channelsAddHelp.indexOf('telegram') === -1) {
            this.log += '\nNote: this openclaw build does not list telegram in `channels add --help`. Telegram auto-add will be skipped.\n';
          }
        } catch (e) {
          this.status = 'Error: ' + String(e);
        }
      },

      updateAuthChoices() {
        const group = this.currentGroup;
        this.authChoices = (group && group.options) ? group.options : [];
        if (this.authChoices.length > 0) {
          this.selectedAuth = this.authChoices[0].value;
        }
      },

      async runSetup() {
        const payload = {
          flow: this.flow,
          authChoice: this.selectedAuth,
          authSecret: this.authSecret,
          model: this.model,
          telegramToken: this.telegramToken,
          discordToken: this.discordToken,
          slackBotToken: this.slackBotToken,
          slackAppToken: this.slackAppToken
        };

        this.log = 'Running...\n';
        this.loading = true;

        try {
          const res = await fetch('/setup/api/run', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const text = await res.text();
          let j;
          try { j = JSON.parse(text); } catch (_e) { j = { ok: false, output: text }; }
          this.log += (j.output || JSON.stringify(j, null, 2));
          await this.refreshStatus();
        } catch (e) {
          this.log += '\nError: ' + String(e) + '\n';
        } finally {
          this.loading = false;
        }
      },

      openPairingModal() {
        this.pairingChannel = '';
        this.pairingCode = '';
        this.showPairingModal = true;
      },

      async approvePairing() {
        const channel = this.pairingChannel.trim().toLowerCase();
        if (channel !== 'telegram' && channel !== 'discord') {
          alert('Channel must be "telegram" or "discord"');
          return;
        }
        const code = this.pairingCode.trim();
        if (!code) {
          alert('Please enter a pairing code');
          return;
        }
        this.showPairingModal = false;
        this.log += '\nApproving pairing for ' + channel + '...\n';

        try {
          const res = await fetch('/setup/api/pairing/approve', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ channel: channel, code: code })
          });
          const t = await res.text();
          this.log += t + '\n';
        } catch (e) {
          this.log += 'Error: ' + String(e) + '\n';
        }
      },

      async resetSetup() {
        if (!confirm('Reset setup? This deletes the config file so onboarding can run again.')) return;
        this.log = 'Resetting...\n';
        this.loading = true;

        try {
          const res = await fetch('/setup/api/reset', { method: 'POST', credentials: 'same-origin' });
          const t = await res.text();
          this.log += t + '\n';
          await this.refreshStatus();
        } catch (e) {
          this.log += 'Error: ' + String(e) + '\n';
        } finally {
          this.loading = false;
        }
      }
    }));
  });
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
</head>
<body x-data="setupApp()">
  <div class="header-row">
    <h1>OpenClaw Setup</h1>
    <button @click="toggleTheme()" class="theme-toggle" x-text="theme === 'dark' ? 'Light mode' : 'Dark mode'"></button>
  </div>
  <p class="muted">This wizard configures OpenClaw by running the same onboarding command it uses in the terminal, but from the browser.</p>

  <div class="card">
    <h2>Status</h2>
    <div x-text="status">Loading...</div>
    <div style="margin-top: 0.75rem">
      <a href="/openclaw" target="_blank">Open OpenClaw UI</a>
      &nbsp;|&nbsp;
      <a href="/setup/export" target="_blank">Download backup (.tar.gz)</a>
    </div>
  </div>

  <div class="card">
    <h2>1) Model/auth provider</h2>
    <p class="muted">Matches the groups shown in the terminal onboarding.</p>
    <label>Provider group</label>
    <select x-model="selectedGroup" @change="updateAuthChoices()">
      <template x-for="g in authGroups" :key="g.value">
        <option :value="g.value" x-text="g.label + (g.hint ? ' - ' + g.hint : '')"></option>
      </template>
    </select>

    <label>Auth method</label>
    <select x-model="selectedAuth">
      <template x-for="o in authChoices" :key="o.value">
        <option :value="o.value" x-text="o.label + (o.hint ? ' - ' + o.hint : '')"></option>
      </template>
    </select>

    <label>Key / Token (if required)</label>
    <input x-model="authSecret" type="password" placeholder="Paste API key / token if applicable" />

    <label>Model</label>
    <input x-model="model" type="text" placeholder="e.g. openai/gpt-4.1, anthropic/claude-sonnet-4" />
    <div class="muted" style="margin-top: 0.25rem">
      Format: provider/model-name (e.g. openai/gpt-4.1, anthropic/claude-sonnet-4, google/gemini-2.5-pro)
    </div>

    <label>Wizard flow</label>
    <select x-model="flow">
      <option value="quickstart">quickstart</option>
      <option value="advanced">advanced</option>
      <option value="manual">manual</option>
    </select>
  </div>

  <div class="card">
    <h2>2) Optional: Channels</h2>
    <p class="muted">You can also add channels later inside OpenClaw, but this helps you get messaging working immediately.</p>

    <label>Telegram bot token (optional)</label>
    <input x-model="telegramToken" type="password" placeholder="123456:ABC..." />
    <div class="muted" style="margin-top: 0.25rem">
      Get it from BotFather: open Telegram, message <code>@BotFather</code>, run <code>/newbot</code>, then copy the token.
    </div>

    <label>Discord bot token (optional)</label>
    <input x-model="discordToken" type="password" placeholder="Bot token" />
    <div class="muted" style="margin-top: 0.25rem">
      Get it from the Discord Developer Portal: create an application, add a Bot, then copy the Bot Token.<br/>
      <strong>Important:</strong> Enable <strong>MESSAGE CONTENT INTENT</strong> in Bot â†’ Privileged Gateway Intents, or the bot will crash on startup.
    </div>

    <label>Slack bot token (optional)</label>
    <input x-model="slackBotToken" type="password" placeholder="xoxb-..." />

    <label>Slack app token (optional)</label>
    <input x-model="slackAppToken" type="password" placeholder="xapp-..." />
  </div>

  <div class="card">
    <h2>3) Run onboarding</h2>
    <button @click="runSetup()" :disabled="loading">Run setup</button>
    <button @click="openPairingModal()" class="secondary-button" :disabled="loading">Approve pairing</button>
    <button @click="resetSetup()" class="tertiary-button" :disabled="loading">Reset setup</button>
    <pre x-text="log"></pre>
    <p class="muted">Reset deletes the OpenClaw config file so you can rerun onboarding. Pairing approval lets you grant DM access when dmPolicy=pairing.</p>
  </div>

  <div x-show="showPairingModal" x-cloak class="modal-overlay" @click.self="showPairingModal = false">
    <div class="modal">
      <h3>Approve Pairing</h3>
      <label>Channel</label>
      <select x-model="pairingChannel">
        <option value="">Select channel...</option>
        <option value="telegram">telegram</option>
        <option value="discord">discord</option>
      </select>
      <label>Pairing code</label>
      <input x-model="pairingCode" type="text" placeholder="e.g. 3EY4PUYS" />
      <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
        <button @click="approvePairing()">Approve</button>
        <button @click="showPairingModal = false" class="secondary-button">Cancel</button>
      </div>
    </div>
  </div>

  <style>
    [x-cloak] { display: none !important; }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--overlay-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: var(--modal-bg);
      padding: 1.5rem;
      border-radius: 8px;
      min-width: 300px;
      border: 1px solid var(--modal-border);
    }
    .modal h3 {
      margin-top: 0;
      margin-bottom: 1rem;
    }
  </style>
</body>
</html>
